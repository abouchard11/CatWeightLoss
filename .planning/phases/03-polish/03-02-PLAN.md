---
phase: 03-polish
plan: 02
type: execute
---

<objective>
Fix device hash fallback to be consistent across app launches.

Purpose: Ensure anonymous metrics use consistent device identifier even when identifierForVendor is nil.
Output: Device hash fallback cached in UserDefaults, consistent across calls.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-phase.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@CatWeightLoss/Models/AnonymousMetric.swift
@.planning/codebase/CONCERNS.md

**Problem:** Lines 100-102 generate random fallback hash each call when vendorId is nil.
**Fix:** Cache fallback in UserDefaults("anon_device_hash_fallback").
**Test:** Create unit test verifying consistency.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix generateDeviceHash fallback caching</name>
  <files>CatWeightLoss/Models/AnonymousMetric.swift</files>
  <action>
Modify generateDeviceHash() to cache fallback:

1. Check UserDefaults for existing fallback first
2. If exists, use cached value
3. If not, generate new random hash and save to UserDefaults
4. Use key: "anon_device_hash_fallback"

This ensures same device gets same hash even if vendorId is nil.
  </action>
  <verify>xcodebuild build</verify>
  <done>Fallback hash is cached in UserDefaults</done>
</task>

<task type="auto">
  <name>Task 2: Add test for hash consistency</name>
  <files>CatWeightLossTests/AnonymousMetricTests.swift</files>
  <action>
Create test file with:

1. **testDeviceHashConsistency**
   - Call generateDeviceHash() twice
   - Assert both calls return same value
   - (Implicitly tests both vendorId path and fallback path)

2. **testDeviceHashFormat**
   - Call generateDeviceHash()
   - Assert length is 16 characters
   - Assert contains only hex characters [0-9a-f]

Simple but effective coverage for the fix.
  </action>
  <verify>xcodebuild -project CatWeightLoss.xcodeproj -scheme CatWeightLossTests -destination 'platform=iOS Simulator,name=iPhone 17' test</verify>
  <done>Hash consistency test passes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Fallback caching implemented
- [ ] All tests pass
- [ ] Hash is consistent across multiple calls
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Device hash is deterministic
</success_criteria>

<output>
After completion, create `.planning/phases/03-polish/03-02-SUMMARY.md`
</output>
